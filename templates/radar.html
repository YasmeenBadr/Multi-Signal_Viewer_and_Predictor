<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>RADAR Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        :root {
            --bg-dark: #0A0A0A;
            --bg-card: #141414;
            --primary-color: #00E8FF;
            --text-light: #E0E0E0;
            --text-muted: #999999;
            --glass-border: rgba(0, 232, 255, 0.2);
            --glass-shadow: rgba(0, 232, 255, 0.1);
        }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            transition: background 0.5s ease;
        }

        h1,
        h2 {
            color: var(--primary-color);
            text-shadow: 0 0 8px var(--glass-shadow);
            font-weight: 700;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px var(--glass-shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px var(--glass-shadow);
        }

        .card p,
        .card li,
        .card h5 {
            color: var(--text-light) !important;
        }

        .nav-tabs {
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--text-muted);
            transition: color 0.3s, background-color 0.3s;
            border-radius: 6px 6px 0 0;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: #1A1A1A;
        }

        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: var(--bg-dark);
            font-weight: 600;
            border-bottom: 3px solid var(--primary-color);
            transform: translateY(1px);
        }

        .btn-custom {
            background-color: var(--primary-color);
            color: var(--bg-dark);
            font-weight: bold;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            letter-spacing: 0.5px;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
        }

        .btn-custom:hover {
            background-color: #00c0cc;
            color: white;
            box-shadow: 0 0 15px rgba(0, 232, 255, 0.5);
            transform: translateY(-2px);
        }

        .btn-outline-light {
            border-color: var(--text-muted);
            color: var(--text-muted);
            transition: all 0.3s;
        }

        .btn-outline-light:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background-color: transparent;
        }

        .form-control {
            background-color: #1A1A1A;
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            box-shadow: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            background-color: #1A1A1A;
            color: var(--text-light);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(0, 232, 255, 0.25);
        }

        .alert-info {
            background-color: rgba(0, 232, 255, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color) !important;
        }

        .alert-info h4,
        .alert-info p,
        .alert-info strong {
            color: var(--primary-color) !important;
        }

        .img-fluid {
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        audio {
            background-color: #1A1A1A;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 5px;
            filter: brightness(0.9) saturate(1.2);
        }

        audio:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 232, 255, 0.2);
        }

        /* Custom Range Slider */
        .form-range {
            height: 6px;
            background: linear-gradient(to right, #FF4444 0%, #FFA500 50%, var(--primary-color) 100%);
            border-radius: 5px;
            outline: none;
        }

        .form-range::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border: 2px solid var(--bg-dark);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 232, 255, 0.5);
            transition: all 0.3s;
        }

        .form-range::-webkit-slider-thumb:hover {
            background: #00c0cc;
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(0, 232, 255, 0.8);
        }

        .form-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border: 2px solid var(--bg-dark);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 232, 255, 0.5);
            transition: all 0.3s;
        }

        .form-range::-moz-range-thumb:hover {
            background: #00c0cc;
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(0, 232, 255, 0.8);
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-2 text-center">RADAR Signal Analysis</h1>
        <p class="text-center mb-5 lead fw-light">Select a category below to analyze signals related to Radar systems.
        </p>

        <ul class="nav nav-tabs mb-4 justify-content-center" id="radarTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="drone-tab" data-bs-toggle="tab" data-bs-target="#drone"
                    type="button" role="tab">Drone Detection</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sar-tab" data-bs-toggle="tab" data-bs-target="#sar" type="button"
                    role="tab">SAR Analysis</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="downsample-tab" data-bs-toggle="tab" data-bs-target="#downsample"
                    type="button" role="tab">Downsampling Demo</button>
            </li>
        </ul>

        <div class="tab-content" id="radarTabsContent">
            <!-- Drone Detection Tab -->
            <div class="tab-pane fade show active" id="drone" role="tabpanel">
                <div class="card p-4">
                    <h2>Acoustic Drone Detection</h2>
                    <p>Upload an audio recording (.wav or .mp3) to detect whether a drone's acoustic signature is
                        present.</p>
                    <form id="droneForm" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control mb-3" accept=".wav,.mp3" required>
                        <button type="submit" class="btn btn-custom w-100">Analyze Drone Audio</button>
                    </form>
                    <div id="resultBox" class="mt-4"></div>
                </div>
            </div>

            <!-- SAR Analysis Tab -->
            <div class="tab-pane fade" id="sar" role="tabpanel">
                <div class="card p-4">
                    <h2>SAR (Synthetic Aperture Radar)</h2>
                    <p>Upload a Sentinel-1 GRD (.tif) file for backscatter visualization and analysis.</p>
                    <form id="sarForm" enctype="multipart/form-data">
                        <input type="file" name="file" id="sar-file" class="form-control mb-3" accept=".tif,.tiff"
                            required>
                        <button type="submit" class="btn btn-custom w-100">Analyze SAR Image</button>
                    </form>
                    <div id="sarResultBox" class="mt-4" style="display:none;"></div>
                </div>
            </div>

            <!-- Downsampling Demo Tab -->
            <div class="tab-pane fade" id="downsample" role="tabpanel">
                <div class="card p-4">
                    <h2>Audio Downsampling & Aliasing</h2>
                    <p>Upload a drone audio file and downsample it to see how aliasing affects detection accuracy.</p>
                    <form id="downsampleForm" enctype="multipart/form-data">
                        <div class="mb-3">

                            <input type="file" name="file" id="downsample-file" class="form-control" accept=".wav,.mp3"
                                required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label d-flex justify-content-between align-items-center"
                                style="color: var(--text-light);">
                                <span>Target Sample Rate</span>
                                <span id="sample-rate-value" class="badge"
                                    style="background-color: var(--primary-color); color: var(--bg-dark); font-size: 1rem; padding: 8px 16px;">8000
                                    Hz</span>
                            </label>
                            <input type="range" class="form-range" id="sample-rate" name="target_sr" min="2000"
                                max="16000" step="1" value="8000">
                            <div class="d-flex justify-content-between mt-2"
                                style="font-size: 0.85rem; color: var(--text-muted);">
                                <span>2 kHz<br><small>(Heavy Aliasing)</small></span>
                                <span class="text-center">9 kHz<br><small>(Moderate)</small></span>
                                <span class="text-end">16 kHz<br><small>(Minimal Aliasing)</small></span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">🔬 Analyze with Downsampling</button>
                    </form>
                    <div id="downsampleResultBox" class="mt-4"></div>
                </div>
            </div>

            <div class="text-center mt-5 mb-5">
                <a href="/" class="btn btn-outline-light">⬅ Back to Home</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Utility functions
        const showLoading = (element, message) => {
            element.innerHTML = `<div class="alert alert-info"><div class="text-center" style="color: var(--primary-color) !important;"><strong>${message}</strong></div></div>`;
        };

        const showError = (element, message) => {
            element.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${message}</div>`;
        };

        const fetchAnalysis = async (url, formData) => {
            const response = await fetch(url, { method: "POST", body: formData });
            if (!response.ok) throw new Error("Server error or file type issue.");
            return response.json();
        };

        // Drone Detection Handler
        document.getElementById("droneForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const resultBox = document.getElementById("resultBox");
            showLoading(resultBox, "Analyzing... Please wait.");

            try {
                const formData = new FormData(e.target);
                const file = formData.get('file');

                // Create a temporary URL for the uploaded file
                const audioUrl = URL.createObjectURL(file);

                const data = await fetchAnalysis("/radar/analyze", formData);
                resultBox.innerHTML = `
                    <div class="alert alert-info">
                        <h4 style="color: var(--primary-color) !important;">Prediction: <strong>${data.predicted_class}</strong></h4>
                        <p style="color: var(--primary-color) !important;">Confidence: <strong>${(data.confidence * 100).toFixed(2)}%</strong></p>
                        <div class="mt-3">
                            <p class="mb-2 small" style="color: var(--text-muted);">🔊 Listen to Uploaded Audio</p>
                            <audio controls style="width: 100%; max-width: 400px;">
                                <source src="${audioUrl}" type="audio/${file.name.split('.').pop()}">
                                Your browser does not support audio playback.
                            </audio>
                        </div>
                    </div>`;
            } catch (err) {
                showError(resultBox, "Could not analyze file. Check the server connection.");
            }
        });

        // SAR Analysis Handler
        document.getElementById("sarForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const sarBox = document.getElementById("sarResultBox");
            sarBox.style.display = "block";
            showLoading(sarBox, "Processing SAR image... This may take a moment.");

            try {
                const data = await fetchAnalysis("/sar/view", new FormData(e.target));
                sarBox.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card p-3 text-center h-100">
                                <h5>Main Display <span class="small">(2–98% Scaled)</span></h5>
                                <img src="${data.main_image}" class="img-fluid rounded">
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card p-3 text-center h-100">
                                <h5>Backscatter Histogram</h5>
                                <img src="${data.histogram}" class="img-fluid rounded">
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card p-3 text-center h-100">
                                <h5>Overlay <span class="small">(Low-Backscatter in Red)</span></h5>
                                <img src="${data.overlay}" class="img-fluid rounded">
                            </div>
                        </div>
                    </div>`;
            } catch (err) {
                showError(sarBox, "Error analyzing SAR file. Ensure it is a valid Sentinel-1 GRD (.tif) file.");
            }
        });

        // Downsampling Handler
        const sampleRateSlider = document.getElementById('sample-rate');
        const sampleRateValue = document.getElementById('sample-rate-value');
        sampleRateSlider.addEventListener('input', () => sampleRateValue.textContent = sampleRateSlider.value);

        document.getElementById("downsampleForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const resultBox = document.getElementById("downsampleResultBox");
            showLoading(resultBox, "Processing original and downsampled audio.");

            try {
                const data = await fetchAnalysis("/radar/analyze_downsampled", new FormData(e.target));
                const changed = data.comparison.classification_changed;
                const changeColor = changed ? '#FF4444' : '#00E8FF';
                const changeIcon = changed ? '⚠️' : '✓';

                resultBox.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h5 class="text-center mb-3" style="color: var(--primary-color);">📡 Original Audio (16 kHz)</h5>
                            <div class="text-center">
                                <p class="mb-2"><strong>Prediction:</strong></p>
                                <h4 style="color: var(--primary-color);">${data.original.predicted_class}</h4>
                                <p class="mt-3 mb-2"><strong>Confidence:</strong></p>
                                <h4 style="color: var(--primary-color);">${(data.original.confidence * 100).toFixed(2)}%</h4>
                                <div class="mt-4">
                                    <p class="mb-2 small text-muted">🔊 Listen to Original</p>
                                    <audio controls style="width: 100%; max-width: 300px;">
                                        <source src="${data.original.audio_url}" type="audio/wav">
                                    </audio>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h5 class="text-center mb-3" style="color: ${changeColor};">🔻 Downsampled Audio (${data.downsampled.sample_rate} Hz)</h5>
                            <div class="text-center">
                                <p class="mb-2"><strong>Prediction:</strong></p>
                                <h4 style="color: ${changeColor};">${data.downsampled.predicted_class}</h4>
                                <p class="mt-3 mb-2"><strong>Confidence:</strong></p>
                                <h4 style="color: ${changeColor};">${(data.downsampled.confidence * 100).toFixed(2)}%</h4>
                                <div class="mt-4">
                                    <p class="mb-2 small text-muted">🔊 Listen to Downsampled</p>
                                    <audio controls style="width: 100%; max-width: 300px;">
                                        <source src="${data.downsampled.audio_url}" type="audio/wav">
                                    </audio>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card p-4">
                            <h5 class="text-center mb-4" style="color: var(--primary-color);">📊 Comparison Results</h5>
                            <div class="row text-center">
                                <div class="col-md-4 mb-3">
                                    <p class="text-muted mb-1">Confidence Drop</p>
                                    <h4 style="color: var(--primary-color);">${(Math.abs(data.comparison.confidence_drop) * 100).toFixed(2)}%</h4>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <p class="text-muted mb-1">Status</p>
                                    <h4 style="color: ${changeColor};">${changeIcon} ${changed ? 'Classification Changed!' : 'Same Classification'}</h4>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <p class="text-muted mb-1">Sample Rate Used</p>
                                    <h4 style="color: var(--primary-color);">${data.downsampled.sample_rate} Hz</h4>
                                </div>
                            </div>
                            ${changed ? `
                                <div class="alert alert-info mt-3 text-center" style="background-color: rgba(255, 68, 68, 0.1); border-color: #FF4444;">
                                    <strong style="color: #FF4444;">Aliasing Effect Detected!</strong><br>
                                    <span style="color: var(--text-light);">The downsampled audio caused the model to change its prediction due to frequency distortion.</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>`;
            } catch (err) {
                showError(resultBox, "Could not analyze file. Check the server connection or file format.");
            }
        });
    </script>
</body>

</html>