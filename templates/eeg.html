<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EEG Real-Time Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background: #000000; color: #e0e0e0; font-family: "Times New Roman", Times, serif; }
    h4, h1 { color: #00eaff; }
    .sidebar { background: #1e1e1e; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    .plot-container { background: #1e1e1e; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    .form-check-label { color: #e0e0e0; }
    .channel-list { max-height: 300px; overflow-y: auto; border: 1px solid #333; padding: 10px; border-radius: 5px; background: #2a2a2a; }
    .btn-primary { background: #00eaff; border: none; color: #000; font-weight: bold; }
    .btn-primary:hover { background: #00bcd4; color: #fff; }
  </style>
</head>
<body class="container-fluid p-4">

  <div class="row">
    <div class="col-md-3 sidebar">
      <h4 class="mb-3">EEG Controls</h4>
      <form id="channelForm">
        <div class="mb-3">
          <label for="width" class="form-label">Window width (seconds)</label>
          <input type="number" id="width" name="width" class="form-control bg-dark text-light" value="5" min="1" step="1">
        </div>

        <div class="mb-3">
          <label for="graphMode" class="form-label">Graph Mode</label>
          <select id="graphMode" class="form-select bg-dark text-light">
            <option value="time">Time Graph</option>
            <option value="polar">Polar Graph</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Select Channels</label>
          <div class="channel-list">
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="0"><label class="form-check-label">Channel 1 (Fp1)</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="1"><label class="form-check-label">Channel 2 (Fp2)</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="2"><label class="form-check-label">Channel 3 (C3)</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="3"><label class="form-check-label">Channel 4 (C4)</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="4"><label class="form-check-label">Channel 5 (P7)</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="5"><label class="form-check-label">Channel 6 (P8)</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="6"><label class="form-check-label">Channel 7 (O1)</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="7"><label class="form-check-label">Channel 8 (O2)</label></div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Start Streaming</button>
      </form>
    </div>

    <div class="col-md-9 plot-container">
      <h4 class="mb-3">EEG Signal Viewer</h4>
      <div id="plot" style="width:100%;height:600px;"></div>
    </div>
  </div>

  <script>
    let streaming = false;
    let intervalId;
    let selected = [];
    let width = 5;
    let mode = "time";
    const fs = 160;
    let channelDataBuffers = {};

    const colors = [
      "#FF5733","#33FF57","#3357FF","#F3FF33","#FF33EC",
      "#33FFF6","#FF8F33","#8F33FF","#33FF99","#FF3333",
      "#FFD700","#00CED1","#ADFF2F","#FF69B4","#FFA07A",
      "#40E0D0","#DC143C","#7FFF00","#8A2BE2","#00FF7F"
    ];

    document.getElementById("channelForm").addEventListener("submit", (e) => {
      e.preventDefault();
      selected = Array.from(document.querySelectorAll("input[name=channels]:checked")).map(ch => parseInt(ch.value));
      width = parseFloat(document.getElementById("width").value);
      mode = document.getElementById("graphMode").value;

      if (selected.length === 0) {
        alert("Please select at least one channel!");
        return;
      }

      const traces = selected.map((ch, i) => {
        const name = document.querySelector(`input[value="${ch}"]`).nextElementSibling.innerText;
        return mode === "time"
          ? { x: [], y: [], mode: "lines", line: { color: colors[i % colors.length] }, name }
          : { r: [], theta: [], mode: "lines", line: { color: colors[i % colors.length] }, name, type: 'scatterpolar' };
      });

      // Reset buffers
      channelDataBuffers = {};
      selected.forEach(chIndex => channelDataBuffers[chIndex] = []);

      const layout = {
        title: `EEG Real-Time Viewer - ${mode === 'time' ? 'Time Graph' : 'Polar Graph'} - Window: ${width}s`,
        paper_bgcolor: "#000000",
        plot_bgcolor: "#000000",
        font: { color: "#e0e0e0", family: "Times New Roman" },
        showlegend: true,
        ...(mode === 'time'
          ? { xaxis: { title: "Time (s)", color: "#e0e0e0", gridcolor: '#333' },
              yaxis: { title: "Amplitude (µV)", color: "#e0e0e0", gridcolor: '#333' } }
          : { polar: { radialaxis: { title: "Amplitude (µV)", color: "#e0e0e0", gridcolor: '#333' },
                       angularaxis: { direction: "clockwise", rotation: 90, color: "#e0e0e0", gridcolor: '#333' } } })
      };

      Plotly.newPlot("plot", traces, layout);
      streaming = true;
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(fetchData, 500);
    });

    async function fetchData() {
      if (!streaming) return;

      try {
        const response = await fetch("/eeg/update", {   // ✅ FIXED ENDPOINT
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ channels: selected, width })
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();

        if (mode === "time") {
          const xUpdate = [];
          const yUpdate = [];
          Object.values(result.signals).forEach(sig => { xUpdate.push(result.time); yUpdate.push(sig); });
          Plotly.extendTraces("plot", { x: xUpdate, y: yUpdate }, selected.map((_, i) => i), width * fs);
        } else {
          const maxPoints = width * fs;
          const rUpdate = [];
          const thetaUpdate = [];

          Object.values(result.signals).forEach((chunk, i) => {
            const chIndex = selected[i];
            const buffer = channelDataBuffers[chIndex];
            buffer.push(...chunk);
            if (buffer.length > maxPoints) buffer.splice(0, buffer.length - maxPoints);

            const N = buffer.length;
            const theta = buffer.map((_, idx) => (idx / (N - 1)) * 360);
            const minVal = Math.min(...buffer);
            const r = buffer.map(v => v - minVal);

            rUpdate.push(r);
            thetaUpdate.push(theta);
          });

          if(rUpdate.length > 0) Plotly.restyle("plot", { r: rUpdate, theta: thetaUpdate });
        }

      } catch (error) {
        console.error("Failed to fetch data:", error);
        streaming = false;
        clearInterval(intervalId);
        alert("Connection to data stream failed. Please check the backend and refresh.");
      }
    }
  </script>
</body>
</html>
