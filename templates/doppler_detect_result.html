<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Doppler Detection Result</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { 
      background: #000; 
      color: #e0e0e0; 
      text-align: center; 
      font-family: "Segoe UI", sans-serif; 
      padding: 20px;
    }
    h1 { 
      color: #00eaff; 
      margin: 30px 0; 
      text-shadow: 0 0 10px rgba(0, 234, 255, 0.5);
    }
    .result-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin: 30px 0;
    }
    .result-box {
      background: #111;
      border: 2px solid #00eaff;
      border-radius: 15px;
      padding: 25px;
      width: 280px;
      color: white;
      box-shadow: 0 0 15px rgba(0, 234, 255, 0.3);
    }
    .result-value {
      color: #00eaff;
      font-size: 2rem;
      font-weight: bold;
      margin: 10px 0;
    }
    .btn-custom {
      background: #00eaff;
      color: black;
      font-weight: bold;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      margin: 20px 0;
      transition: all 0.3s;
    }
    .btn-custom:hover {
      background: #00c0cc;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 234, 255, 0.4);
    }
    .signal-canvas {
      display: block;
      margin: 20px auto;
      border: 2px solid #00eaff;
      background: #111;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      height: 200px;
    }
    .sampling-control {
      background: rgba(0, 234, 255, 0.1);
      padding: 25px;
      border-radius: 15px;
      margin: 30px auto;
      max-width: 800px;
      border: 1px solid #00eaff;
      box-shadow: 0 0 20px rgba(0, 234, 255, 0.2);
    }
    .sampling-slider {
      width: 100%;
      margin: 20px 0;
      height: 10px;
      border-radius: 5px;
    }
    .comparison-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 40px;
      margin: 40px 0;
    }
    .signal-column {
      flex: 1;
      min-width: 350px;
      max-width: 500px;
    }
    .status-indicator {
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .status-good { 
      background: rgba(0, 255, 0, 0.2); 
      color: #00ff00; 
      border: 1px solid #00ff00;
    }
    .status-warning { 
      background: rgba(255, 255, 0, 0.2); 
      color: #ffff00; 
      border: 1px solid #ffff00;
    }
    .status-danger { 
      background: rgba(255, 0, 0, 0.2); 
      color: #ff6666; 
      border: 1px solid #ff6666;
    }
    .audio-player {
      width: 100%;
      max-width: 500px;
      margin: 15px auto;
      border-radius: 10px;
    }
    .signal-title {
      color: #00eaff;
      margin: 20px 0 10px 0;
      font-size: 1.3rem;
    }
    .info-text {
      color: #aaa;
      font-size: 0.9rem;
      margin: 5px 0;
    }
    .generate-btn {
      background: #00eaff;
      color: black;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s;
    }
    .generate-btn:hover {
      background: #00c0cc;
      transform: translateY(-2px);
    }
    .generate-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    .aliasing-demo {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid #ff6666;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöó Doppler Detection Results</h1>

    <!-- Detection Results -->
    <div class="result-container">
      <div class="result-box">
        <h4>üéØ Predicted Speed</h4>
        <div class="result-value">{{ estimated_speed }} km/hr</div>
      </div>
      <div class="result-box">
        <h4>üìä Predicted Frequency</h4>
        <div class="result-value">{{ f_original }} Hz</div>
      </div>
    </div>

    <!-- Sampling Control Section -->
    <div class="sampling-control">
      <h3>üéöÔ∏è Sampling & Aliasing Demonstration</h3>
      
      <div class="mb-3">
        <!-- CHANGED: Wider range with lower minimum for better aliasing demonstration -->
        <input type="range" class="sampling-slider" id="samplingSlider" 
               min="500" max="20000" step="100" value="2000">
        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
          <small>500 Hz</small>
          <small>10000 Hz</small>
          <small>20000 Hz</small>
        </div>

      <!-- Generate Button -->
      <button class="generate-btn" id="generateBtn">
        üîÑ Generate Car Sound
      </button>

    </div>

    <!-- Signal Comparison -->
    <div class="comparison-container">
      <!-- Original Uploaded Signal -->
      <div class="signal-column">
        <h4 class="signal-title">üìÅ Original Uploaded Signal</h4>
        <canvas id="originalCanvas" class="signal-canvas" width="500" height="200"></canvas>
        <audio controls class="audio-player" id="originalAudio">
          <source src="{{ url_for('doppler.serve_audio', file_id=audio_file_id) }}" type="audio/wav">
          Your browser does not support the audio element.
        </audio>
        <p class="info-text">Original uploaded file - Reference signal</p>
      </div>

      <!-- Generated Signal After Sampling -->
      <div class="signal-column">
        <h4 class="signal-title">üîä Generated Car Sound (After Sampling)</h4>
        <canvas id="sampledCanvas" class="signal-canvas" width="500" height="200"></canvas>
        <audio controls id="generatedAudio" class="audio-player">
          <!-- Audio source will be updated via JavaScript -->
        </audio>
        <p class="info-text" id="samplingRateLabel">Sampling rate: 2000 Hz</p>
        <div id="generatedInfo" class="info-text">Click "Generate" to create sound</div>
      </div>
    </div>

    <a href="{{ url_for('doppler.index') }}" class="btn-custom">‚¨ÖÔ∏è Back to Generator</a>
  </div>

  <script>
    // Safe data loading
    let originalYData = [];
    let originalXData = [];
    let audioFileId = "";
    let originalFreq = { f_original };
    let estimatedSpeed = { estimated_speed };

    try {
      originalYData = { y_plot_json , safe };
      originalXData = { x_plot_json , safe };
      audioFileId = "{{ audio_file_id }}";
      console.log("‚úÖ Data loaded successfully");
    } catch (error) {
      console.error("‚ùå Error loading data:", error);
    }

    // Calculate Nyquist frequency for aliasing demonstration
    const nyquistFrequency = originalFreq * 2 * 3; // Account for harmonics (3rd harmonic)
    const severeAliasingThreshold = nyquistFrequency * 0.5;
    const moderateAliasingThreshold = nyquistFrequency * 0.8;

    // Wait for page to load
    document.addEventListener('DOMContentLoaded', function() {
      console.log("üöÄ Initializing Doppler Detection...");
      
      // Update Nyquist display
      document.getElementById('nyquistDisplay').textContent = nyquistFrequency + ' Hz';
      document.getElementById('nyquistThreshold').textContent = moderateAliasingThreshold + ' Hz';
      
      // Draw original signal immediately
      drawOriginalSignal();
      
      // Set up slider for real-time display updates
      const slider = document.getElementById('samplingSlider');
      if (slider) {
        slider.addEventListener('input', function(e) {
          const selectedFs = parseInt(e.target.value);
          document.getElementById('currentSampling').textContent = selectedFs;
          document.getElementById('samplingRateLabel').textContent = `Sampling rate: ${selectedFs} Hz`;
          updateAliasingStatus(selectedFs);
        });
        
        // Initialize aliasing status
        updateAliasingStatus(parseInt(slider.value));
      }
      
      // Set up generate button - THIS IS THE KEY BUTTON
      const generateBtn = document.getElementById('generateBtn');
      if (generateBtn) {
        generateBtn.addEventListener('click', function() {
          const selectedFs = parseInt(document.getElementById('samplingSlider').value);
          console.log("üéõÔ∏è Generate button clicked with sampling rate:", selectedFs);
          generateNewCarSound(selectedFs);
        });
      }
      
      // Auto-generate on page load to demonstrate initial state
      setTimeout(() => {
        const initialFs = parseInt(document.getElementById('samplingSlider').value);
        console.log("üîÑ Auto-generating with initial sampling rate:", initialFs);
        generateNewCarSound(initialFs);
      }, 1000);
    });

    function updateAliasingStatus(fs) {
      const statusElement = document.getElementById('aliasingStatus');
      if (!statusElement) return;
      
      if (fs >= nyquistFrequency) {
        statusElement.innerHTML = '‚úÖ <strong>No aliasing expected</strong><br><small>Sampling rate is above Nyquist</small>';
        statusElement.className = 'status-indicator status-good';
      } else if (fs >= moderateAliasingThreshold) {
        statusElement.innerHTML = '‚ö†Ô∏è <strong>Moderate aliasing possible</strong><br><small>Some distortion may occur</small>';
        statusElement.className = 'status-indicator status-warning';
      } else {
        statusElement.innerHTML = '‚ùå <strong>Severe aliasing expected</strong><br><small>Robot-like distorted sounds</small>';
        statusElement.className = 'status-indicator status-danger';
      }
    }

    function drawOriginalSignal() {
      const canvas = document.getElementById('originalCanvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw background
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw grid for better visualization
      ctx.strokeStyle = 'rgba(0, 234, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let x = 0; x < canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y < canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      
      // Draw signal if data exists
      if (originalXData && originalYData && originalXData.length > 0 && originalYData.length > 0) {
        ctx.beginPath();
        ctx.moveTo(0, canvas.height / 2);
        
        // Use appropriate scaling
        const xScale = canvas.width / originalXData.length;
        const yScale = canvas.height * 0.4; // 80% of canvas height for amplitude
        
        for (let i = 0; i < originalXData.length; i++) {
          const x = i * xScale;
          const y = (canvas.height / 2) - (originalYData[i] * yScale);
          ctx.lineTo(x, y);
        }
        
        ctx.strokeStyle = "#00eaff";
        ctx.lineWidth = 2;
        ctx.stroke();
        
        console.log("‚úÖ Original signal drawn with", originalXData.length, "points");
      } else {
        // Show message if no data
        ctx.fillStyle = '#00eaff';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Original uploaded signal', canvas.width / 2, canvas.height / 2);
      }
    }

    function drawSampledSignal(xData, yData) {
      const canvas = document.getElementById('sampledCanvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw background
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw grid
      ctx.strokeStyle = 'rgba(0, 234, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let x = 0; x < canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y < canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      if (xData && yData && xData.length > 0 && yData.length > 0) {
        ctx.beginPath();
        ctx.moveTo(0, canvas.height / 2);
        
        const xScale = canvas.width / xData.length;
        const yScale = canvas.height * 0.4;
        
        for (let i = 0; i < xData.length; i++) {
          const x = i * xScale;
          const y = (canvas.height / 2) - (yData[i] * yScale);
          ctx.lineTo(x, y);
        }
        
        ctx.strokeStyle = "#00eaff";
        ctx.lineWidth = 2;
        ctx.stroke();
        
        document.getElementById('generatedInfo').textContent = `Generated with ${xData.length} points`;
        console.log("‚úÖ Sampled signal drawn successfully");
      } else {
        ctx.fillStyle = '#00eaff';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Click "Generate" to create signal', canvas.width / 2, canvas.height / 2);
      }
    }

    function generateNewCarSound(targetFs) {
      console.log("üöÄ Generating new car sound with sampling rate:", targetFs);

      const canvas = document.getElementById('sampledCanvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const generateBtn = document.getElementById('generateBtn');
      
      // Show loading state
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#00eaff';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('üîÑ Generating...', canvas.width / 2, canvas.height / 2);

      // Update button state
      if (generateBtn) {
        generateBtn.textContent = 'üîÑ Generating...';
        generateBtn.disabled = true;
      }

      // Send request to generate new audio
      fetch('{{ url_for("doppler.generate_downsampled_audio") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          target_fs: targetFs,
          estimated_speed: estimatedSpeed,
          estimated_freq: originalFreq
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Server error: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("‚úÖ Server response:", data);
        
        if (data.success) {
          // Update audio player
          const audioPlayer = document.getElementById('generatedAudio');
          if (audioPlayer && data.generated_file_id) {
            const newSource = '{{ url_for("doppler.serve_audio", file_id="") }}' + data.generated_file_id + '?t=' + new Date().getTime();
            audioPlayer.src = newSource;
            console.log("üéµ Audio source updated to:", newSource);
            
            // Force audio reload
            audioPlayer.load();
          }
          
          // Draw the new signal
          if (data.x_plot && data.y_plot) {
            drawSampledSignal(data.x_plot, data.y_plot);
          }
          
          console.log("üéâ Audio generation completed successfully!");
        } else {
          throw new Error(data.error || 'Unknown server error');
        }
      })
      .catch(error => {
        console.error('‚ùå Error generating audio:', error);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#ff6666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Error: ' + error.message, canvas.width / 2, canvas.height / 2);
      })
      .finally(() => {
        // Reset button
        if (generateBtn) {
          generateBtn.textContent = 'üîÑ Generate Car Sound';
          generateBtn.disabled = false;
        }
      });
    }
  </script>
</body>
</html>