<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ECG Real-Time Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background: #000000; color: #e0e0e0; font-family: "Times New Roman", Times, serif; }
    h4, h1 { color: #00eaff; }
    .sidebar { background: #1e1e1e; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    .plot-container { background: #1e1e1e; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    .form-check-label { color: #e0e0e0; }
    .btn-primary { background: #00eaff; border: none; color: #000; font-weight: bold; }
    .btn-primary:hover { background: #00bcd4; color: #fff; }
  </style>
</head>
<body class="container-fluid p-4">

  <div class="row">
    <!-- Sidebar Controls -->
    <div class="col-md-3 sidebar">
      <h4 class="mb-3">ECG Controls</h4>
      <form id="channelForm">
        <div class="mb-3">
          <label for="width" class="form-label">Window width (seconds)</label>
          <input type="number" id="width" name="width" class="form-control bg-dark text-light" value="5" min="1" step="1">
        </div>

        <div class="mb-3">
          <label for="graphMode" class="form-label">Graph Mode</label>
          <select id="graphMode" class="form-select bg-dark text-light">
            <option value="time">Time Graph</option>
            <option value="polar">Polar Graph</option>
            <option value="recurrence">Recurrence Plot</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Select Channels</label>
          <div id="channelList" class="channel-list">
            <!-- Channels will be injected dynamically if needed -->
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="0"><label class="form-check-label">ECG Lead I</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="1"><label class="form-check-label">ECG Lead II</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="channels" value="2"><label class="form-check-label">ECG Lead III</label></div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Start Streaming</button>
      </form>
    </div>

    <!-- Plot Area -->
    <div class="col-md-9 plot-container">
      <h4 class="mb-3">ECG Signal Viewer</h4>
      <div id="plot" style="width:100%;height:600px;"></div>
    </div>
  </div>

  <script>
    let streaming = false;
    let intervalId;
    let selected = [];
    let width = 5;
    let mode = "time";
    const fs = 360;   // ECG sample rate (can adjust)
    let channelDataBuffers = {};

    document.getElementById("channelForm").addEventListener("submit", (e) => {
      e.preventDefault();
      selected = Array.from(document.querySelectorAll("input[name=channels]:checked")).map(ch => parseInt(ch.value));
      width = parseFloat(document.getElementById("width").value);
      mode = document.getElementById("graphMode").value;

      if (selected.length === 0) {
        alert("Please select at least one channel!");
        return;
      }

      channelDataBuffers = {};
      selected.forEach(ch => channelDataBuffers[ch] = []);

      let traces;
      if (mode === "time") {
        traces = selected.map((ch, i) => ({
          x: [], y: [], mode: "lines", name: `Channel ${ch+1}`
        }));
      } else if (mode === "polar") {
        traces = selected.map((ch, i) => ({
          r: [], theta: [], mode: "lines", type: "scatterpolar", name: `Channel ${ch+1}`
        }));
      } else if (mode === "recurrence") {
        traces = [{ z: [[]], type: "heatmap", colorscale: "Viridis", name: "Recurrence Plot" }];
      }

      Plotly.newPlot("plot", traces, { 
        paper_bgcolor: "#000", plot_bgcolor: "#000", font: { color: "#e0e0e0" } 
      });

      streaming = true;
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(fetchData, 500);
    });

    async function fetchData() {
      if (!streaming) return;
      try {
        const response = await fetch("/ecg/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ channels: selected, width })
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();

        if (mode === "time") {
          const xUpdate = [], yUpdate = [];
          Object.values(result.signals).forEach(sig => {
            xUpdate.push(result.time); 
            yUpdate.push(sig);
          });
          Plotly.extendTraces("plot", { x: xUpdate, y: yUpdate }, selected.map((_, i) => i), width*fs);
        } 
        else if (mode === "polar") {
          const rUpdate = [], thetaUpdate = [];
          Object.values(result.signals).forEach((chunk) => {
            const N = chunk.length;
            const theta = chunk.map((_, idx) => (idx / (N-1)) * 360);
            const minVal = Math.min(...chunk);
            const r = chunk.map(v => v - minVal);
            rUpdate.push(r);
            thetaUpdate.push(theta);
          });
          Plotly.restyle("plot", { r: rUpdate, theta: thetaUpdate });
        } 
        else if (mode === "recurrence") {
          const signal = Object.values(result.signals)[0]; // just first channel
          const N = signal.length;
          const recurrence = [];
          for (let i=0; i<N; i++) {
            const row = [];
            for (let j=0; j<N; j++) row.push(Math.abs(signal[i] - signal[j]));
            recurrence.push(row);
          }
          Plotly.react("plot", [{ z: recurrence, type: "heatmap", colorscale: "Viridis" }]);
        }

      } catch (error) {
        console.error("Fetch error:", error);
        streaming = false;
        clearInterval(intervalId);
        alert("Connection lost. Restart backend and refresh.");
      }
    }
  </script>
</body>
</html>
